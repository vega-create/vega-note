---
import BaseLayout from './BaseLayout.astro';
import TableOfContents from '../components/TableOfContents.astro';
import ArticleSchema from '../components/ArticleSchema.astro';
import BreadcrumbSchema from '../components/BreadcrumbSchema.astro';
import FAQSchema from '../components/FAQSchema.astro';
import { siteConfig } from '../site.config';

interface Props {
  title: string;
  description: string;
  publishDate: Date;
  category: string;
  tags?: string[];
  image?: string;
  imageAlt?: string;
  faq?: Array<{ q: string; a: string }>;
  headings: Array<{ depth: number; slug: string; text: string }>;
}

const { title, description, publishDate, category, tags = [], image, imageAlt, faq, headings } = Astro.props;
const catInfo = siteConfig.categories.find(c => c.slug === category);
const catLabel = catInfo ? `${catInfo.emoji} ${catInfo.label}` : category;
const dateStr = publishDate.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' });

// Add FAQ to TOC headings
const tocHeadings = faq && faq.length > 0
  ? [...headings, { depth: 2, slug: 'å¸¸è¦‹å•é¡Œ', text: 'ğŸ’¬ å¸¸è¦‹å•é¡Œ' }]
  : headings;

const breadcrumbs = [
  { name: 'é¦–é ', href: '/' },
  { name: 'éƒ¨è½æ ¼', href: '/blog/' },
  { name: title, href: Astro.url.pathname },
];
---

<BaseLayout title={title} description={description} image={image} type="article" publishDate={publishDate}>
  <ArticleSchema title={title} description={description} publishDate={publishDate} image={image} url={Astro.url.pathname} />
  <BreadcrumbSchema items={breadcrumbs} />
  {faq && faq.length > 0 && <FAQSchema faq={faq} />}

  <article class="max-w-3xl mx-auto px-5 py-10 animate-fade-in">
    <!-- Breadcrumb -->
    <nav class="text-sm text-warm-400 mb-6 flex items-center gap-1.5 flex-wrap">
      <a href="/" class="hover:text-accent-peach transition-colors">é¦–é </a>
      <span>/</span>
      <a href="/blog/" class="hover:text-accent-peach transition-colors">éƒ¨è½æ ¼</a>
      <span>/</span>
      <span class="text-warm-600 truncate max-w-[200px]">{title}</span>
    </nav>

    <!-- Header -->
    <header class="mb-8">
      <div class="flex items-center gap-3 mb-4">
        <span class={`inline-block px-3 py-1 rounded-full text-xs font-medium cat-${category}`}>
          {catLabel}
        </span>
        <time class="text-sm text-warm-400">{dateStr}</time>
      </div>
      <h1 class="text-2xl md:text-3xl font-display font-bold text-warm-900 leading-tight mb-4">
        {title}
      </h1>
      <p class="text-warm-500 text-base leading-relaxed">{description}</p>
    </header>

    <!-- Cover Image -->
    {image && (
      <div class="mb-8 rounded-notebook overflow-hidden shadow-card">
        <img src={image} alt={imageAlt || title} class="w-full h-auto" loading="eager" />
      </div>
    )}

    <!-- TOC -->
    <TableOfContents headings={tocHeadings} />

    <!-- Article Content -->
    <div class="prose max-w-none">
      <slot />
    </div>

    <!-- Tags -->
    {tags.length > 0 && (
      <div class="mt-10 pt-6 border-t border-cream-300 flex items-center gap-2 flex-wrap">
        <span class="text-sm text-warm-400">æ¨™ç±¤ï¼š</span>
        {tags.map(tag => (
          <span class="px-2.5 py-1 bg-cream-200 text-warm-600 rounded-full text-xs">{tag}</span>
        ))}
      </div>
    )}

    <!-- FAQ Section -->
    {faq && faq.length > 0 && (
      <section class="mt-12 pt-8 border-t border-cream-300">
        <h2 id="å¸¸è¦‹å•é¡Œ" class="text-xl font-display font-bold text-warm-900 mb-6">ğŸ’¬ å¸¸è¦‹å•é¡Œ</h2>
        <div class="space-y-4">
          {faq.map(item => (
            <details class="group bg-cream-100 rounded-notebook border border-cream-300 overflow-hidden">
              <summary class="flex items-center justify-between px-5 py-4 cursor-pointer font-medium text-warm-800 hover:text-accent-peach transition-colors">
                <span>{item.q}</span>
                <svg class="w-5 h-5 text-warm-400 group-open:rotate-180 transition-transform flex-shrink-0 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </summary>
              <div class="px-5 pb-4 text-warm-600 text-sm leading-relaxed border-t border-cream-200 pt-3">
                {item.a}
              </div>
            </details>
          ))}
        </div>
      </section>
    )}
  </article>
</BaseLayout>
