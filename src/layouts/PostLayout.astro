---
import BaseLayout from './BaseLayout.astro';
import TableOfContents from '../components/TableOfContents.astro';
import ArticleSchema from '../components/ArticleSchema.astro';
import BreadcrumbSchema from '../components/BreadcrumbSchema.astro';
import FAQSchema from '../components/FAQSchema.astro';
import { siteConfig } from '../site.config';
import { getCollection } from 'astro:content';

interface Props {
  title: string;
  description: string;
  publishDate: Date;
  category: string;
  tags?: string[];
  image?: string;
  imageAlt?: string;
  faq?: Array<{ q: string; a: string }>;
  headings: Array<{ depth: number; slug: string; text: string }>;
}

const { title, description, publishDate, category, tags = [], image, imageAlt, faq, headings } = Astro.props;

// Related posts
const allPosts = await getCollection('posts');
const relatedItems = allPosts
  .filter(p => p.data.category === category && !Astro.url.pathname.includes(p.slug))
  .sort((a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf())
  .slice(0, 3)
  .map(p => ({
    url: `/posts/${p.slug}`,
    title: p.data.title,
    image: p.data.image || '',
    imageAlt: p.data.imageAlt || p.data.title,
    description: p.data.description || '',
  }));
const catInfo = siteConfig.categories.find(c => c.slug === category);
const catLabel = catInfo ? `${catInfo.emoji} ${catInfo.label}` : category;
const dateStr = publishDate.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' });

// Add FAQ to TOC headings
const tocHeadings = faq && faq.length > 0
  ? [...headings, { depth: 2, slug: 'å¸¸è¦‹å•é¡Œ', text: 'ğŸ’¬ å¸¸è¦‹å•é¡Œ' }]
  : headings;

const breadcrumbs = [
  { name: 'é¦–é ', href: '/' },
  { name: 'éƒ¨è½æ ¼', href: '/blog/' },
  { name: title, href: Astro.url.pathname },
];
---

<BaseLayout title={title} description={description} image={image} type="article" publishDate={publishDate}>
  <ArticleSchema title={title} description={description} publishDate={publishDate} image={image} url={Astro.url.pathname} />
  <BreadcrumbSchema items={breadcrumbs} />
  {faq && faq.length > 0 && <FAQSchema faq={faq} />}

  <article class="max-w-3xl mx-auto px-5 py-10 animate-fade-in">
    <!-- Breadcrumb -->
    <nav class="text-sm text-warm-400 mb-6 flex items-center gap-1.5 flex-wrap">
      <a href="/" class="hover:text-accent-peach transition-colors">é¦–é </a>
      <span>/</span>
      <a href="/blog/" class="hover:text-accent-peach transition-colors">éƒ¨è½æ ¼</a>
      <span>/</span>
      <span class="text-warm-600 truncate max-w-[200px]">{title}</span>
    </nav>

    <!-- Header -->
    <header class="mb-8">
      <div class="flex items-center gap-3 mb-4">
        <span class={`inline-block px-3 py-1 rounded-full text-xs font-medium cat-${category}`}>
          {catLabel}
        </span>
        <time class="text-sm text-warm-400">{dateStr}</time>
        <span class="text-sm text-warm-400">Â· <a href="/about/" class="hover:text-accent-peach transition-colors">{siteConfig.author}</a></span>
      </div>
      <h1 class="text-2xl md:text-3xl font-display font-bold text-warm-900 leading-tight mb-4">
        {title}
      </h1>
      <p class="text-warm-500 text-base leading-relaxed">{description}</p>
    </header>

    <!-- Cover Image -->
    {image && (
      <div class="mb-8 rounded-notebook overflow-hidden shadow-card">
        <img src={image} alt={imageAlt || title} class="w-full h-auto" loading="eager" />
      </div>
    )}

    <!-- TOC -->
    <TableOfContents headings={tocHeadings} />

    <!-- Article Content -->
    <div class="prose max-w-none">
      <slot />
    </div>

    <!-- Tags -->
    {tags.length > 0 && (
      <div class="mt-10 pt-6 border-t border-cream-300 flex items-center gap-2 flex-wrap">
        <span class="text-sm text-warm-400">æ¨™ç±¤ï¼š</span>
        {tags.map(tag => (
          <span class="px-2.5 py-1 bg-cream-200 text-warm-600 rounded-full text-xs">{tag}</span>
        ))}
      </div>
    )}

    <!-- FAQ Section -->
    {faq && faq.length > 0 && (
      <section class="mt-12 pt-8 border-t border-cream-300">
        <h2 id="å¸¸è¦‹å•é¡Œ" class="text-xl font-display font-bold text-warm-900 mb-6">ğŸ’¬ å¸¸è¦‹å•é¡Œ</h2>
        <div class="space-y-4">
          {faq.map(item => (
            <details class="group bg-cream-100 rounded-notebook border border-cream-300 overflow-hidden">
              <summary class="flex items-center justify-between px-5 py-4 cursor-pointer font-medium text-warm-800 hover:text-accent-peach transition-colors">
                <span>{item.q}</span>
                <svg class="w-5 h-5 text-warm-400 group-open:rotate-180 transition-transform flex-shrink-0 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </summary>
              <div class="px-5 pb-4 text-warm-600 text-sm leading-relaxed border-t border-cream-200 pt-3">
                {item.a}
              </div>
            </details>
          ))}
        </div>
      </section>
    )}
    <!-- ç›¸é—œæ–‡ç«  -->
    {relatedItems.length > 0 && (
      <section class="mt-12 pt-8 border-t border-cream-300">
        <h2 class="font-display font-bold text-warm-900 text-xl mb-6">ğŸ“š å»¶ä¼¸é–±è®€</h2>
        <div class="grid md:grid-cols-3 gap-4">
          {relatedItems.map((item) => (
            <a href={item.url} class="group bg-white border border-cream-300 rounded-notebook overflow-hidden hover:shadow-card-hover hover:-translate-y-0.5 transition-all duration-300">
              {item.image && (
                <img src={item.image} alt={item.imageAlt} class="w-full h-36 object-cover" loading="lazy" />
              )}
              <div class="p-4">
                <h3 class="font-semibold text-warm-800 group-hover:text-accent-peach transition-colors text-sm line-clamp-2">{item.title}</h3>
                <p class="text-xs text-warm-500 mt-2 line-clamp-2">{item.description}</p>
              </div>
            </a>
          ))}
        </div>
      </section>
    )}

    <!-- ä½œè€…æ¡† -->
    <div class="mt-12 pt-8 border-t border-cream-300">
      <div class="flex gap-4 items-center bg-cream-100/60 border border-cream-300 rounded-notebook p-5">
        <div class="text-4xl flex-shrink-0">âœï¸</div>
        <div>
          <a href="/about/" class="font-display font-bold text-warm-900 hover:text-accent-peach transition-colors">{siteConfig.author}</a>
          <p class="text-sm text-warm-500 mt-1">ç†±æ„›å­¸ç¿’çš„æ•¸ä½å·¥ä½œè€…ï¼Œç”¨æ–‡å­—è¨˜éŒ„ AIã€è¡ŒéŠ·ã€é–‹ç™¼çš„æ¯ä¸€æ­¥æˆé•·ã€‚</p>
        </div>
      </div>
    </div>
  </article>
</BaseLayout>
