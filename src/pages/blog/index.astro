---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { siteConfig } from '../../site.config';

const now = new Date();
const allPosts = await getCollection('posts', ({ data }) => {
  return !data.draft && data.publishDate <= now;
});
const posts = allPosts.sort((a, b) => b.data.publishDate.getTime() - a.data.publishDate.getTime());
const categories = siteConfig.categories;
---

<BaseLayout title="éƒ¨è½æ ¼" description="Vega çš„å­¸ç¿’ç­†è¨˜ â€” AIã€è¡ŒéŠ·ã€é–‹ç™¼ã€ç”Ÿæ´»">
  <section class="max-w-4xl mx-auto px-5 py-12 animate-fade-in">
    <h1 class="text-2xl font-display font-bold text-warm-900 mb-2">ğŸ“– æ‰€æœ‰ç­†è¨˜</h1>
    <p class="text-warm-500 mb-8">ç›®å‰å…± {posts.length} ç¯‡ç­†è¨˜</p>

    <!-- Category Filter -->
    <div class="flex items-center gap-2 mb-8 flex-wrap" id="category-filter">
      <button
        data-cat="all"
        class="cat-btn active px-4 py-2 rounded-full text-sm font-medium bg-warm-800 text-cream-50 transition-all"
      >
        å…¨éƒ¨
      </button>
      {categories.map(cat => (
        <button
          data-cat={cat.slug}
          class="cat-btn px-4 py-2 rounded-full text-sm font-medium bg-cream-200 text-warm-600 hover:bg-cream-300 transition-all"
        >
          {cat.emoji} {cat.label}
        </button>
      ))}
    </div>

    <!-- Posts Grid -->
    <div class="grid md:grid-cols-2 gap-5" id="posts-grid">
      {posts.map((post) => {
        const catInfo = categories.find(c => c.slug === post.data.category);
        const dateStr = post.data.publishDate.toLocaleDateString('zh-TW', { year: 'numeric', month: 'short', day: 'numeric' });
        return (
          <a
            href={`/posts/${post.slug}/`}
            class="post-card group bg-white border border-cream-300 rounded-notebook p-5 hover:shadow-card-hover hover:border-cream-400 hover:-translate-y-0.5 transition-all duration-300"
            data-category={post.data.category}
          >
            {post.data.image && (
              <div class="rounded-lg overflow-hidden mb-4 aspect-video bg-cream-200">
                <img
                  src={post.data.image}
                  alt={post.data.imageAlt || post.data.title}
                  class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                  loading="lazy"
                />
              </div>
            )}
            <div class="flex items-center gap-2 mb-2">
              {catInfo && (
                <span class={`inline-block px-2 py-0.5 rounded-full text-xs font-medium cat-${post.data.category}`}>
                  {catInfo.emoji} {catInfo.label}
                </span>
              )}
              <time class="text-xs text-warm-400">{dateStr}</time>
            </div>
            <h2 class="font-display font-semibold text-warm-900 group-hover:text-accent-peach transition-colors leading-snug mb-2">
              {post.data.title}
            </h2>
            <p class="text-sm text-warm-500 line-clamp-2 leading-relaxed">
              {post.data.description}
            </p>
          </a>
        );
      })}
    </div>

    {posts.length === 0 && (
      <div class="bg-white border border-cream-300 rounded-notebook p-10 text-center">
        <p class="text-warm-400 text-lg mb-2">ğŸ“</p>
        <p class="text-warm-500">ç­†è¨˜æº–å‚™ä¸­ï¼Œæ•¬è«‹æœŸå¾…ï¼</p>
      </div>
    )}
  </section>
</BaseLayout>

<script>
  // Category filter logic
  const btns = document.querySelectorAll('.cat-btn');
  const cards = document.querySelectorAll('.post-card');

  // Check URL for category param
  const urlParams = new URLSearchParams(window.location.search);
  const urlCat = urlParams.get('cat');
  if (urlCat) {
    filterByCategory(urlCat);
  }

  btns.forEach(btn => {
    btn.addEventListener('click', () => {
      const cat = btn.getAttribute('data-cat') || 'all';
      filterByCategory(cat);
    });
  });

  function filterByCategory(cat: string) {
    btns.forEach(b => {
      b.classList.remove('active', 'bg-warm-800', 'text-cream-50');
      b.classList.add('bg-cream-200', 'text-warm-600');
    });

    const activeBtn = document.querySelector(`.cat-btn[data-cat="${cat}"]`);
    if (activeBtn) {
      activeBtn.classList.add('active', 'bg-warm-800', 'text-cream-50');
      activeBtn.classList.remove('bg-cream-200', 'text-warm-600');
    }

    cards.forEach(card => {
      const cardCat = card.getAttribute('data-category');
      if (cat === 'all' || cardCat === cat) {
        (card as HTMLElement).style.display = '';
      } else {
        (card as HTMLElement).style.display = 'none';
      }
    });
  }
</script>
